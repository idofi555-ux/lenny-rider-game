<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Lenny Rider">
  <meta name="theme-color" content="#00ffff">
  <meta name="description" content="Ultimate Neon Racing Game - Collect coins, do flips, and race through the neon city!">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <title>Lenny's Rider</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #0a0a1a;
      font-family: 'Arial Black', Arial, sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    #menu {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, #0a0a2e 0%, #1a0a3e 50%, #2a1a4e 100%);
    }

    #menu.hidden { display: none; }

    .title {
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 0 0 30px #00ffff, 0 0 60px #00ffff;
      color: #fff;
      letter-spacing: 4px;
    }

    .subtitle {
      color: #ff00ff;
      font-size: 1.2em;
      margin-bottom: 40px;
      text-shadow: 0 0 20px #ff00ff;
    }

    .car-preview {
      font-size: 80px;
      margin-bottom: 30px;
      animation: carBounce 1s ease-in-out infinite;
    }

    @keyframes carBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .btn {
      background: linear-gradient(180deg, #00ff88 0%, #00cc66 100%);
      color: #003322;
      border: none;
      padding: 20px 60px;
      font-size: 24px;
      font-weight: bold;
      border-radius: 50px;
      margin: 10px;
      cursor: pointer;
      -webkit-appearance: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      box-shadow: 0 0 20px rgba(0,255,136,0.5), inset 0 2px 0 rgba(255,255,255,0.3);
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .btn:active {
      transform: scale(0.95);
      box-shadow: 0 0 10px rgba(0,255,136,0.5);
    }

    .btn.garage {
      background: linear-gradient(180deg, #ff00ff 0%, #cc00cc 100%);
      color: #330033;
      box-shadow: 0 0 20px rgba(255,0,255,0.5), inset 0 2px 0 rgba(255,255,255,0.3);
    }

    #game {
      display: none;
      width: 100%;
      height: 100%;
    }

    #game.active { display: block; }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    #controls {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
      display: none;
      justify-content: space-between;
      padding: 0 20px;
      pointer-events: none;
    }

    #controls.active { display: flex; }

    #boost, #jump {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 3px solid;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      -webkit-appearance: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      z-index: 1000;
      pointer-events: auto;
      text-transform: uppercase;
    }

    #boost {
      background: linear-gradient(180deg, #ff6600 0%, #cc4400 100%);
      border-color: #ff8833;
      color: #fff;
      box-shadow: 0 0 20px rgba(255,102,0,0.6);
    }

    #jump {
      background: linear-gradient(180deg, #00ff88 0%, #00cc66 100%);
      border-color: #00ffaa;
      color: #003322;
      box-shadow: 0 0 20px rgba(0,255,136,0.6);
    }

    #endRun {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid #ff0066;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      background: linear-gradient(180deg, #ff0066 0%, #cc0044 100%);
      color: #fff;
      box-shadow: 0 0 15px rgba(255,0,102,0.6);
      -webkit-appearance: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      z-index: 1000;
      pointer-events: auto;
    }

    #hud {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 15px 20px;
      display: none;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(180deg, rgba(0,0,0,0.5) 0%, transparent 100%);
    }

    #hud.active { display: flex; }

    .hud-item {
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      text-shadow: 0 0 10px currentColor;
    }

    .hud-score { color: #00ffff; }
    .hud-coins { color: #ffcc00; }
    .hud-lives { font-size: 22px; }

    #powerupDisplay {
      position: fixed;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 100;
    }

    .powerup-indicator {
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      color: #fff;
      text-shadow: 0 0 10px currentColor;
      animation: powerupPulse 0.5s ease-in-out infinite alternate;
    }

    @keyframes powerupPulse {
      from { transform: scale(1); opacity: 0.8; }
      to { transform: scale(1.05); opacity: 1; }
    }

    .powerup-shield { background: rgba(0, 150, 255, 0.8); }
    .powerup-magnet { background: rgba(200, 0, 255, 0.8); }
    .powerup-double { background: rgba(255, 200, 0, 0.8); color: #333; }
    .powerup-superjump { background: rgba(0, 255, 100, 0.8); color: #333; }

    #gameOver {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    #gameOver.active { display: flex; }

    .game-over-title {
      color: #ff0066;
      font-size: 3em;
      text-shadow: 0 0 30px #ff0066;
      margin-bottom: 20px;
    }

    .final-score {
      color: #00ffff;
      font-size: 2em;
      margin-bottom: 30px;
    }

    /* Leaderboard styles */
    #leaderboard {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    #leaderboard.active { display: flex; }

    .leaderboard-title {
      color: #ffcc00;
      font-size: 2.5em;
      text-shadow: 0 0 30px #ffcc00;
      margin-bottom: 20px;
    }

    .leaderboard-list {
      background: rgba(20, 20, 40, 0.9);
      border: 3px solid #00ffff;
      border-radius: 15px;
      padding: 20px;
      min-width: 300px;
      max-width: 90%;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
    }

    .leaderboard-entry {
      display: flex;
      justify-content: space-between;
      padding: 10px 15px;
      margin: 5px 0;
      border-radius: 8px;
      font-size: 1.1em;
    }

    .leaderboard-entry:nth-child(1) {
      background: linear-gradient(90deg, rgba(255,215,0,0.3) 0%, transparent 100%);
      color: #ffd700;
    }

    .leaderboard-entry:nth-child(2) {
      background: linear-gradient(90deg, rgba(192,192,192,0.3) 0%, transparent 100%);
      color: #c0c0c0;
    }

    .leaderboard-entry:nth-child(3) {
      background: linear-gradient(90deg, rgba(205,127,50,0.3) 0%, transparent 100%);
      color: #cd7f32;
    }

    .leaderboard-entry:nth-child(n+4) {
      color: #aaa;
    }

    .entry-rank {
      width: 30px;
      font-weight: bold;
    }

    .entry-name {
      flex: 1;
      text-align: left;
      margin-left: 10px;
    }

    .entry-score {
      font-weight: bold;
      color: #00ffff;
    }

    .name-input-container {
      margin: 20px 0;
      text-align: center;
    }

    .name-input-container label {
      color: #fff;
      font-size: 1.2em;
      display: block;
      margin-bottom: 10px;
    }

    #playerName {
      background: rgba(20, 20, 40, 0.9);
      border: 2px solid #00ffff;
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 1.2em;
      color: #fff;
      text-align: center;
      width: 200px;
      font-family: inherit;
    }

    #playerName:focus {
      outline: none;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    }

    .new-highscore {
      color: #00ff00;
      font-size: 1.5em;
      text-shadow: 0 0 20px #00ff00;
      margin-bottom: 15px;
      animation: highscorePulse 0.5s ease-in-out infinite alternate;
    }

    @keyframes highscorePulse {
      from { transform: scale(1); }
      to { transform: scale(1.1); }
    }

    .btn.leaderboard {
      background: linear-gradient(180deg, #ffcc00 0%, #cc9900 100%);
      color: #332200;
      box-shadow: 0 0 20px rgba(255,204,0,0.5), inset 0 2px 0 rgba(255,255,255,0.3);
    }

    /* Garage Screen */
    #garage {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(180deg, #0a0a2e 0%, #1a0a3e 50%, #2a1a4e 100%);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2500;
    }

    #garage.active { display: flex; }

    .garage-title {
      color: #ff00ff;
      font-size: 2.5em;
      text-shadow: 0 0 30px #ff00ff;
      margin-bottom: 10px;
    }

    .car-name {
      color: #00ffff;
      font-size: 1.5em;
      text-shadow: 0 0 20px #00ffff;
      margin-bottom: 20px;
      min-height: 40px;
    }

    #garageCanvas {
      border: 3px solid #ff00ff;
      border-radius: 20px;
      box-shadow: 0 0 40px rgba(255, 0, 255, 0.4);
      margin-bottom: 20px;
    }

    .car-selector {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .nav-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 3px solid #00ffff;
      background: rgba(0, 255, 255, 0.2);
      color: #00ffff;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      -webkit-appearance: none;
      touch-action: manipulation;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
      transition: all 0.2s;
    }

    .nav-btn:active {
      transform: scale(0.9);
      background: rgba(0, 255, 255, 0.4);
    }

    .car-dots {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .car-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: all 0.3s;
    }

    .car-dot.active {
      background: #00ffff;
      box-shadow: 0 0 10px #00ffff;
    }
  </style>
</head>
<body>

<div id="menu">
  <div class="car-preview">üèéÔ∏è</div>
  <div class="title">LENNY'S RIDER</div>
  <div class="subtitle">Ultimate Neon Racing</div>
  <button class="btn" id="playBtn">PLAY</button>
  <button class="btn garage" id="garageBtn">GARAGE</button>
  <button class="btn leaderboard" id="leaderboardBtn">LEADERBOARD</button>
</div>

<div id="game">
  <canvas id="canvas"></canvas>
</div>

<div id="hud">
  <div class="hud-item hud-score">SCORE: <span id="scoreNum">0</span></div>
  <div class="hud-item hud-coins">COINS: <span id="coinNum">0</span></div>
</div>

<div id="powerupDisplay"></div>

<div id="controls">
  <button id="boost">BOOST</button>
  <button id="endRun">END</button>
  <button id="jump">JUMP</button>
</div>

<div id="gameOver">
  <div class="game-over-title">RUN COMPLETE!</div>
  <div class="final-score">Score: <span id="finalScore">0</span></div>
  <div id="highscoreMessage" class="new-highscore" style="display:none;">NEW HIGH SCORE!</div>
  <div class="name-input-container">
    <label for="playerName">Enter your name:</label>
    <input type="text" id="playerName" maxlength="12" placeholder="Player" autocomplete="off">
  </div>
  <button class="btn" id="submitScoreBtn">SUBMIT SCORE</button>
  <button class="btn" id="retryBtn">RETRY</button>
  <button class="btn garage" id="menuBtn">MENU</button>
</div>

<div id="leaderboard">
  <div class="leaderboard-title">LEADERBOARD</div>
  <div class="leaderboard-list" id="leaderboardList">
    <div class="leaderboard-entry">Loading...</div>
  </div>
  <button class="btn" id="closeLeaderboardBtn">CLOSE</button>
</div>

<div id="garage">
  <div class="garage-title">GARAGE</div>
  <div class="car-name" id="carNameDisplay">Neon Cyan</div>
  <canvas id="garageCanvas" width="320" height="200"></canvas>
  <div class="car-selector">
    <button class="nav-btn" id="prevCarBtn">‚óÄ</button>
    <div class="car-dots" id="carDots"></div>
    <button class="nav-btn" id="nextCarBtn">‚ñ∂</button>
  </div>
  <button class="btn" id="selectCarBtn">SELECT</button>
  <button class="btn garage" id="closeGarageBtn">BACK</button>
</div>

<script>
// ===========================================
// LENNY'S RIDER - Ultimate Neon Racing Game
// ===========================================

// ============ AUDIO SYSTEM ============
var audioCtx = null;
var musicPlaying = false;
var boostSound = null;
var musicGain = null;
var audioUnlocked = false;

function initAudio() {
  if (audioCtx && audioUnlocked) return;

  // Create audio context if needed
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  // Resume if suspended (iOS requirement)
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }

  // Play silent buffer to unlock audio on iOS
  if (!audioUnlocked) {
    var buffer = audioCtx.createBuffer(1, 1, 22050);
    var source = audioCtx.createBufferSource();
    source.buffer = buffer;
    source.connect(audioCtx.destination);
    source.start(0);
    audioUnlocked = true;
  }
}

// Unlock audio on any touch (for iOS/iPad)
document.addEventListener('touchstart', function() {
  initAudio();
}, { once: false });
document.addEventListener('touchend', function() {
  initAudio();
}, { once: false });

// Play a simple tone
function playTone(freq, duration, type, volume, delay) {
  if (!audioCtx) return;
  var osc = audioCtx.createOscillator();
  var gain = audioCtx.createGain();
  osc.type = type || 'sine';
  osc.frequency.value = freq;
  gain.gain.value = volume || 0.3;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  var startTime = audioCtx.currentTime + (delay || 0);
  osc.start(startTime);
  gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
  osc.stop(startTime + duration + 0.1);
}

// Jump sound - rising whoosh
function playJumpSound() {
  if (!audioCtx) return;
  var osc = audioCtx.createOscillator();
  var gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(150, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.15);
  gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.25);
}

// Coin collect sound - happy bling
function playCoinSound() {
  if (!audioCtx) return;
  playTone(880, 0.1, 'sine', 0.2, 0);
  playTone(1100, 0.1, 'sine', 0.2, 0.05);
  playTone(1320, 0.15, 'sine', 0.25, 0.1);
}

// Boost start sound - just a short whoosh, not continuous
function playBoostStartSound() {
  if (!audioCtx) return;
  // Short engine rev sound
  playTone(120, 0.15, 'sine', 0.1, 0);
  playTone(180, 0.1, 'sine', 0.08, 0.1);
}

// Stop boost sound - no continuous sound to stop
function stopBoostSound() {
  // No continuous sound anymore
}

// Game over sound - sad descending
function playGameOverSound() {
  if (!audioCtx) return;
  playTone(440, 0.3, 'sine', 0.3, 0);
  playTone(350, 0.3, 'sine', 0.25, 0.25);
  playTone(280, 0.5, 'sine', 0.2, 0.5);
}

// Button click sound
function playClickSound() {
  if (!audioCtx) return;
  playTone(600, 0.08, 'square', 0.15, 0);
}

// Hit obstacle sound
function playHitSound() {
  if (!audioCtx) return;
  playTone(100, 0.15, 'sawtooth', 0.4, 0);
  playTone(80, 0.2, 'sawtooth', 0.3, 0.1);
}

// Shield break sound
function playShieldBreakSound() {
  if (!audioCtx) return;
  playTone(800, 0.1, 'sine', 0.3, 0);
  playTone(400, 0.15, 'sine', 0.2, 0.08);
  playTone(200, 0.2, 'sine', 0.15, 0.15);
}

// Power-up collect sound
function playPowerupSound() {
  if (!audioCtx) return;
  playTone(523, 0.1, 'sine', 0.25, 0);
  playTone(659, 0.1, 'sine', 0.25, 0.08);
  playTone(784, 0.1, 'sine', 0.25, 0.16);
  playTone(1047, 0.2, 'sine', 0.3, 0.24);
}

// Flip sound - whooshing spin
function playFlipSound() {
  if (!audioCtx) return;
  playTone(200, 0.1, 'sine', 0.2, 0);
  playTone(300, 0.1, 'sine', 0.25, 0.1);
  playTone(400, 0.1, 'sine', 0.3, 0.2);
  playTone(500, 0.15, 'sine', 0.25, 0.3);
}

// Background music - synthwave style
var musicNotes = [];
var musicIndex = 0;
var musicInterval = null;

function startMusic() {
  if (!audioCtx || musicPlaying) return;
  musicPlaying = true;

  // Create master gain for music
  musicGain = audioCtx.createGain();
  musicGain.gain.value = 0.15;
  musicGain.connect(audioCtx.destination);

  // Bass line pattern (notes in Hz)
  var bassPattern = [110, 110, 146.83, 146.83, 130.81, 130.81, 164.81, 164.81];
  // Melody pattern
  var melodyPattern = [330, 392, 440, 392, 330, 294, 330, 392];
  var beatIndex = 0;

  musicInterval = setInterval(function() {
    if (!musicPlaying || !audioCtx) {
      clearInterval(musicInterval);
      return;
    }

    // Bass note
    var bassOsc = audioCtx.createOscillator();
    var bassGain = audioCtx.createGain();
    bassOsc.type = 'sawtooth';
    bassOsc.frequency.value = bassPattern[beatIndex % bassPattern.length];
    bassGain.gain.setValueAtTime(0.12, audioCtx.currentTime);
    bassGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
    bassOsc.connect(bassGain);
    bassGain.connect(musicGain);
    bassOsc.start();
    bassOsc.stop(audioCtx.currentTime + 0.25);

    // Melody note (every 2 beats)
    if (beatIndex % 2 === 0) {
      var melOsc = audioCtx.createOscillator();
      var melGain = audioCtx.createGain();
      melOsc.type = 'triangle';
      melOsc.frequency.value = melodyPattern[(beatIndex / 2) % melodyPattern.length];
      melGain.gain.setValueAtTime(0.08, audioCtx.currentTime);
      melGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.35);
      melOsc.connect(melGain);
      melGain.connect(musicGain);
      melOsc.start();
      melOsc.stop(audioCtx.currentTime + 0.4);
    }

    // Hi-hat sound (every beat)
    var noise = audioCtx.createOscillator();
    var noiseGain = audioCtx.createGain();
    noise.type = 'square';
    noise.frequency.value = 1000 + Math.random() * 500;
    noiseGain.gain.setValueAtTime(0.03, audioCtx.currentTime);
    noiseGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
    noise.connect(noiseGain);
    noiseGain.connect(musicGain);
    noise.start();
    noise.stop(audioCtx.currentTime + 0.06);

    // Kick drum (every 4 beats)
    if (beatIndex % 4 === 0) {
      var kick = audioCtx.createOscillator();
      var kickGain = audioCtx.createGain();
      kick.type = 'sine';
      kick.frequency.setValueAtTime(150, audioCtx.currentTime);
      kick.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.1);
      kickGain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      kickGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
      kick.connect(kickGain);
      kickGain.connect(musicGain);
      kick.start();
      kick.stop(audioCtx.currentTime + 0.2);
    }

    beatIndex++;
  }, 180); // ~166 BPM
}

function stopMusic() {
  musicPlaying = false;
  if (musicInterval) {
    clearInterval(musicInterval);
    musicInterval = null;
  }
  if (boostSound) {
    stopBoostSound();
  }
}

// ============ END AUDIO SYSTEM ============

// ============ LEADERBOARD SYSTEM ============
var cachedLeaderboard = [];
var scoreSubmitted = false;

function fetchLeaderboard(callback) {
  fetch('/api/leaderboard')
    .then(function(response) { return response.json(); })
    .then(function(data) {
      cachedLeaderboard = data;
      if (callback) callback(data);
    })
    .catch(function(err) {
      console.error('Failed to fetch leaderboard:', err);
      if (callback) callback([]);
    });
}

function displayLeaderboard(data) {
  var html = '';
  if (data.length === 0) {
    html = '<div class="leaderboard-entry">No scores yet!</div>';
  } else {
    for (var i = 0; i < data.length; i++) {
      var entry = data[i];
      html += '<div class="leaderboard-entry">';
      html += '<span class="entry-rank">#' + (i + 1) + '</span>';
      html += '<span class="entry-name">' + entry.name + '</span>';
      html += '<span class="entry-score">' + entry.score + '</span>';
      html += '</div>';
    }
  }
  leaderboardList.innerHTML = html;
}

function showLeaderboard() {
  playClickSound();
  leaderboardScreen.className = 'active';
  fetchLeaderboard(displayLeaderboard);
}

function hideLeaderboard() {
  playClickSound();
  leaderboardScreen.className = '';
}

function submitScore() {
  if (scoreSubmitted) return;

  var name = playerNameInput.value.trim() || 'Player';
  playClickSound();

  fetch('/api/score', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: name, score: score })
  })
  .then(function(response) { return response.json(); })
  .then(function(data) {
    scoreSubmitted = true;
    submitScoreBtn.textContent = 'SUBMITTED!';
    submitScoreBtn.style.opacity = '0.5';

    if (data.rank && data.rank <= 10) {
      highscoreMessage.style.display = 'block';
      highscoreMessage.textContent = 'RANK #' + data.rank + '!';
    }

    cachedLeaderboard = data.leaderboard;
  })
  .catch(function(err) {
    console.error('Failed to submit score:', err);
    submitScoreBtn.textContent = 'ERROR - RETRY';
    scoreSubmitted = false;
  });
}

function checkIfHighScore() {
  if (cachedLeaderboard.length < 10) return true;
  var lowestScore = cachedLeaderboard[cachedLeaderboard.length - 1].score;
  return score > lowestScore;
}
// ============ END LEADERBOARD SYSTEM ============

// ============ GARAGE SYSTEM ============
var garageWheelRotation = 0;
var garageAnimationId = null;

function drawGarageCar(ctx, x, y, scale, mainColor, accentColor, wheelRot) {
  ctx.save();
  ctx.translate(x, y);
  ctx.scale(scale, scale);

  // Car shadow
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.beginPath();
  ctx.ellipse(0, 35, 55, 12, 0, 0, Math.PI * 2);
  ctx.fill();

  // Undercarriage glow
  ctx.fillStyle = accentColor;
  ctx.globalAlpha = 0.3;
  ctx.beginPath();
  ctx.ellipse(0, 30, 50, 8, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.globalAlpha = 1;

  // Main body glow
  ctx.shadowColor = mainColor;
  ctx.shadowBlur = 30;

  // Lower body
  ctx.fillStyle = mainColor;
  ctx.beginPath();
  ctx.moveTo(-55, 10);
  ctx.quadraticCurveTo(-60, 0, -50, -10);
  ctx.lineTo(-35, -15);
  ctx.lineTo(35, -15);
  ctx.quadraticCurveTo(60, -10, 60, 5);
  ctx.lineTo(60, 12);
  ctx.lineTo(-55, 12);
  ctx.closePath();
  ctx.fill();

  // Upper body / cabin
  ctx.beginPath();
  ctx.moveTo(-20, -15);
  ctx.quadraticCurveTo(-15, -35, 5, -38);
  ctx.quadraticCurveTo(25, -38, 30, -20);
  ctx.lineTo(30, -15);
  ctx.lineTo(-20, -15);
  ctx.closePath();
  ctx.fill();

  ctx.shadowBlur = 0;

  // Accent stripe
  ctx.fillStyle = accentColor;
  ctx.globalAlpha = 0.8;
  ctx.fillRect(-50, 2, 105, 8);
  ctx.globalAlpha = 1;

  // Racing stripes on hood
  ctx.fillStyle = accentColor;
  ctx.globalAlpha = 0.6;
  ctx.fillRect(-3, -14, 6, 25);
  ctx.globalAlpha = 1;

  // Windshield
  ctx.fillStyle = '#1a3a5c';
  ctx.beginPath();
  ctx.moveTo(-15, -15);
  ctx.quadraticCurveTo(-10, -32, 5, -34);
  ctx.quadraticCurveTo(20, -34, 25, -18);
  ctx.lineTo(25, -15);
  ctx.lineTo(-15, -15);
  ctx.closePath();
  ctx.fill();

  // Windshield reflection
  ctx.fillStyle = 'rgba(255,255,255,0.3)';
  ctx.beginPath();
  ctx.moveTo(-10, -16);
  ctx.lineTo(-5, -28);
  ctx.lineTo(5, -28);
  ctx.lineTo(0, -16);
  ctx.closePath();
  ctx.fill();

  // Side window
  ctx.fillStyle = '#1a3a5c';
  ctx.beginPath();
  ctx.moveTo(-18, -14);
  ctx.lineTo(-25, -14);
  ctx.lineTo(-22, -8);
  ctx.lineTo(-18, -8);
  ctx.closePath();
  ctx.fill();

  // Front spoiler
  ctx.fillStyle = accentColor;
  ctx.fillRect(50, 6, 12, 6);

  // Rear spoiler wing
  ctx.fillStyle = accentColor;
  ctx.beginPath();
  ctx.moveTo(-52, -12);
  ctx.lineTo(-62, -22);
  ctx.lineTo(-52, -22);
  ctx.lineTo(-48, -15);
  ctx.closePath();
  ctx.fill();
  // Wing stand
  ctx.fillRect(-55, -22, 3, 10);

  // Air intake on hood
  ctx.fillStyle = '#111';
  ctx.fillRect(10, -14, 15, 4);
  ctx.fillStyle = accentColor;
  ctx.globalAlpha = 0.5;
  ctx.fillRect(11, -13, 13, 2);
  ctx.globalAlpha = 1;

  // Headlights
  ctx.fillStyle = '#ffffcc';
  ctx.shadowColor = '#ffffaa';
  ctx.shadowBlur = 25;
  ctx.beginPath();
  ctx.ellipse(56, -5, 5, 4, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.ellipse(56, 5, 5, 4, 0, 0, Math.PI * 2);
  ctx.fill();

  // Tail lights
  ctx.fillStyle = '#ff0033';
  ctx.shadowColor = '#ff0000';
  ctx.shadowBlur = 20;
  ctx.beginPath();
  ctx.ellipse(-54, -5, 4, 3, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.ellipse(-54, 5, 4, 3, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;

  // Exhaust pipes
  ctx.fillStyle = '#444';
  ctx.beginPath();
  ctx.ellipse(-58, 8, 4, 3, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#222';
  ctx.beginPath();
  ctx.ellipse(-58, 8, 2, 1.5, 0, 0, Math.PI * 2);
  ctx.fill();

  // Front wheel
  ctx.save();
  ctx.translate(35, 18);
  ctx.rotate(wheelRot);
  drawWheel(ctx, 0, 0, 18, mainColor, accentColor);
  ctx.restore();

  // Rear wheel
  ctx.save();
  ctx.translate(-35, 18);
  ctx.rotate(wheelRot);
  drawWheel(ctx, 0, 0, 18, mainColor, accentColor);
  ctx.restore();

  ctx.restore();
}

function drawWheel(ctx, x, y, radius, mainColor, accentColor) {
  // Tire
  ctx.fillStyle = '#0a0a0a';
  ctx.beginPath();
  ctx.arc(x, y, radius, 0, Math.PI * 2);
  ctx.fill();

  // Tire tread marks
  ctx.strokeStyle = '#1a1a1a';
  ctx.lineWidth = 1;
  for (var i = 0; i < 8; i++) {
    var angle = (i / 8) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(x + Math.cos(angle) * (radius - 3), y + Math.sin(angle) * (radius - 3));
    ctx.lineTo(x + Math.cos(angle) * radius, y + Math.sin(angle) * radius);
    ctx.stroke();
  }

  // Outer rim
  ctx.fillStyle = '#666';
  ctx.beginPath();
  ctx.arc(x, y, radius - 4, 0, Math.PI * 2);
  ctx.fill();

  // Inner rim
  ctx.fillStyle = '#888';
  ctx.beginPath();
  ctx.arc(x, y, radius - 7, 0, Math.PI * 2);
  ctx.fill();

  // Hub
  ctx.fillStyle = accentColor;
  ctx.shadowColor = accentColor;
  ctx.shadowBlur = 10;
  ctx.beginPath();
  ctx.arc(x, y, 6, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;

  // Spokes
  ctx.strokeStyle = '#555';
  ctx.lineWidth = 3;
  for (var i = 0; i < 5; i++) {
    var angle = (i / 5) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(x + Math.cos(angle) * 4, y + Math.sin(angle) * 4);
    ctx.lineTo(x + Math.cos(angle) * (radius - 6), y + Math.sin(angle) * (radius - 6));
    ctx.stroke();
  }
}

function renderGaragePreview() {
  var gw = garageCanvas.width;
  var gh = garageCanvas.height;

  // Clear with gradient background
  var grad = garageCtx.createLinearGradient(0, 0, 0, gh);
  grad.addColorStop(0, '#1a1a3e');
  grad.addColorStop(1, '#0a0a2e');
  garageCtx.fillStyle = grad;
  garageCtx.fillRect(0, 0, gw, gh);

  // Floor reflection
  garageCtx.fillStyle = 'rgba(255,255,255,0.05)';
  garageCtx.fillRect(0, gh - 40, gw, 40);

  // Grid lines on floor
  garageCtx.strokeStyle = 'rgba(0,255,255,0.1)';
  garageCtx.lineWidth = 1;
  for (var i = 0; i < gw; i += 30) {
    garageCtx.beginPath();
    garageCtx.moveTo(i, gh - 40);
    garageCtx.lineTo(i, gh);
    garageCtx.stroke();
  }

  // Get current preview car colors
  var carData = carColors[garagePreviewCar];

  // Draw the car
  garageWheelRotation += 0.05;
  drawGarageCar(garageCtx, gw / 2, gh / 2 + 10, 1.3, carData.main, carData.accent, garageWheelRotation);

  // Continue animation
  garageAnimationId = requestAnimationFrame(renderGaragePreview);
}

function updateCarDots() {
  var html = '';
  for (var i = 0; i < carColors.length; i++) {
    html += '<div class="car-dot' + (i === garagePreviewCar ? ' active' : '') + '"></div>';
  }
  carDots.innerHTML = html;
}

function showGarage() {
  initAudio();
  playClickSound();
  garagePreviewCar = selectedCar;
  garageScreen.className = 'active';
  carNameDisplay.textContent = carColors[garagePreviewCar].name;
  updateCarDots();
  renderGaragePreview();
}

function hideGarage() {
  playClickSound();
  garageScreen.className = '';
  if (garageAnimationId) {
    cancelAnimationFrame(garageAnimationId);
    garageAnimationId = null;
  }
}

function nextCar() {
  playClickSound();
  garagePreviewCar = (garagePreviewCar + 1) % carColors.length;
  carNameDisplay.textContent = carColors[garagePreviewCar].name;
  updateCarDots();
}

function prevCar() {
  playClickSound();
  garagePreviewCar = (garagePreviewCar - 1 + carColors.length) % carColors.length;
  carNameDisplay.textContent = carColors[garagePreviewCar].name;
  updateCarDots();
}

function selectCar() {
  playClickSound();
  selectedCar = garagePreviewCar;
  hideGarage();
}
// ============ END GARAGE SYSTEM ============

var menu = document.getElementById('menu');
var game = document.getElementById('game');
var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
var hud = document.getElementById('hud');
var controls = document.getElementById('controls');
var gameOverScreen = document.getElementById('gameOver');

var playBtn = document.getElementById('playBtn');
var garageBtn = document.getElementById('garageBtn');
var leaderboardBtn = document.getElementById('leaderboardBtn');
var boostBtn = document.getElementById('boost');
var jumpBtn = document.getElementById('jump');
var endRunBtn = document.getElementById('endRun');
var retryBtn = document.getElementById('retryBtn');
var menuBtn = document.getElementById('menuBtn');
var submitScoreBtn = document.getElementById('submitScoreBtn');
var closeLeaderboardBtn = document.getElementById('closeLeaderboardBtn');
var leaderboardScreen = document.getElementById('leaderboard');
var leaderboardList = document.getElementById('leaderboardList');
var playerNameInput = document.getElementById('playerName');
var highscoreMessage = document.getElementById('highscoreMessage');

// Garage elements
var garageScreen = document.getElementById('garage');
var garageCanvas = document.getElementById('garageCanvas');
var garageCtx = garageCanvas.getContext('2d');
var carNameDisplay = document.getElementById('carNameDisplay');
var carDots = document.getElementById('carDots');
var prevCarBtn = document.getElementById('prevCarBtn');
var nextCarBtn = document.getElementById('nextCarBtn');
var selectCarBtn = document.getElementById('selectCarBtn');
var closeGarageBtn = document.getElementById('closeGarageBtn');
var garagePreviewCar = 0; // Currently previewed car in garage

var scoreNum = document.getElementById('scoreNum');
var coinNum = document.getElementById('coinNum');
var finalScore = document.getElementById('finalScore');

// Game state
var playing = false;
var gameOver = false;
var score = 0;
var coinsCollected = 0;
var speed = 8;
var maxSpeed = 25;
var cameraX = 0;
var time = 0;

// Car properties
var car = {
  x: 200,
  y: 300,
  vy: 0,
  rotation: 0,
  onGround: true,
  wheelRotation: 0,
  color: '#00ffff',
  accentColor: '#ff00ff'
};

// Track and objects
var track = [];
var coins = [];
var particles = [];
var stars = [];
var cityBuildings = [];
var mountains = [];
var powerups = [];

// Power-up state
var activeEffects = {
  shield: 0,
  magnet: 0,
  doubleCoins: 0,
  superJump: 0
};

// Controls
var boosting = false;
var jumpPressed = false;

// Flip mechanics
var lastJumpTime = 0;
var isFlipping = false;
var flipRotation = 0;
var flipSpeed = 0.35; // Radians per frame

// DOM elements for power-ups
var powerupDisplay = document.getElementById('powerupDisplay');

// Selected car (for garage) - 12 awesome cars!
var carColors = [
  { main: '#00ffff', accent: '#ff00ff', name: 'Neon Cyan' },
  { main: '#ff0066', accent: '#ffff00', name: 'Hot Pink' },
  { main: '#00ff00', accent: '#00ffff', name: 'Electric Green' },
  { main: '#ff6600', accent: '#ffff00', name: 'Flame Orange' },
  { main: '#9900ff', accent: '#00ffff', name: 'Purple Rain' },
  { main: '#ffff00', accent: '#ff0066', name: 'Golden Flash' },
  { main: '#ff0000', accent: '#ffffff', name: 'Racing Red' },
  { main: '#0066ff', accent: '#00ffff', name: 'Ocean Blue' },
  { main: '#ffffff', accent: '#000000', name: 'Ghost White' },
  { main: '#ff00ff', accent: '#00ff00', name: 'Neon Pink' },
  { main: '#00ffcc', accent: '#ff6600', name: 'Turbo Teal' },
  { main: '#ffcc00', accent: '#9900ff', name: 'Sunset Gold' }
];
var selectedCar = 0;

// Generate stars for background
function generateStars() {
  stars = [];
  for (var i = 0; i < 200; i++) {
    stars.push({
      x: Math.random() * 5000,
      y: Math.random() * 300,
      size: Math.random() * 2 + 0.5,
      twinkle: Math.random() * Math.PI * 2
    });
  }
}

// Generate city buildings
function generateCity() {
  cityBuildings = [];
  var x = -200;
  while (x < 50000) {
    var height = 50 + Math.random() * 150;
    var width = 30 + Math.random() * 50;
    cityBuildings.push({
      x: x,
      width: width,
      height: height,
      windows: Math.floor(height / 20),
      windowCols: Math.floor(width / 15)
    });
    x += width + 20 + Math.random() * 60;
  }
}

// Generate mountains
function generateMountains() {
  mountains = [];
  var x = -500;
  while (x < 50000) {
    var height = 100 + Math.random() * 200;
    mountains.push({
      x: x,
      height: height,
      width: 200 + Math.random() * 300
    });
    x += 150 + Math.random() * 200;
  }
}

// Generate track
function generateTrack() {
  track = [];
  coins = [];
  powerups = [];
  var x = -200;
  var y = 450;

  for (var i = 0; i < 2000; i++) {
    // Create hills and valleys
    if (i > 20 && Math.random() < 0.08) {
      var change = (Math.random() - 0.5) * 60;
      y = Math.max(250, Math.min(550, y + change));
    }

    track.push({ x: x, y: y });

    // Add coins (lowered height for easier collection)
    if (i > 10 && Math.random() < 0.15) {
      coins.push({
        x: x,
        y: y - 50,
        collected: false,
        rotation: Math.random() * Math.PI * 2
      });
    }

    // Add power-ups
    if (i > 25 && Math.random() < 0.025) {
      var powerupTypes = ['shield', 'magnet', 'doubleCoins', 'superJump'];
      var ptype = powerupTypes[Math.floor(Math.random() * powerupTypes.length)];
      powerups.push({
        x: x,
        y: y - 100,
        type: ptype,
        collected: false,
        rotation: 0
      });
    }

    x += 80;
  }
}

function getGroundY(px) {
  for (var i = 0; i < track.length - 1; i++) {
    if (px >= track[i].x && px < track[i + 1].x) {
      var t = (px - track[i].x) / (track[i + 1].x - track[i].x);
      return track[i].y * (1 - t) + track[i + 1].y * t;
    }
  }
  return 600;
}

function getGroundAngle(px) {
  for (var i = 0; i < track.length - 1; i++) {
    if (px >= track[i].x && px < track[i + 1].x) {
      var dx = track[i + 1].x - track[i].x;
      var dy = track[i + 1].y - track[i].y;
      return Math.atan2(dy, dx);
    }
  }
  return 0;
}

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

function spawnParticle(x, y, type) {
  var color = '#00ffff';
  var count = 3;
  if (type === 'boost') color = '#ff6600';
  else if (type === 'coin') { color = '#ffcc00'; count = 10; }
  else if (type === 'powerup') { color = '#ff00ff'; count = 15; }
  else if (type === 'hit') { color = '#ff0000'; count = 20; }
  else if (type === 'shield') { color = '#00aaff'; count = 25; }

  for (var i = 0; i < count; i++) {
    particles.push({
      x: x,
      y: y,
      vx: (Math.random() - 0.5) * (count > 5 ? 10 : 4),
      vy: -Math.random() * 5 - 2,
      life: 1,
      decay: 0.02 + Math.random() * 0.02,
      size: count > 5 ? 4 + Math.random() * 4 : 2 + Math.random() * 3,
      color: color
    });
  }
}

function activatePowerup(type) {
  if (type === 'shield') {
    activeEffects.shield = 10; // 10 seconds
  } else if (type === 'magnet') {
    activeEffects.magnet = 8; // 8 seconds
  } else if (type === 'doubleCoins') {
    activeEffects.doubleCoins = 10; // 10 seconds
  } else if (type === 'superJump') {
    activeEffects.superJump = 8; // 8 seconds
  }
}

function startGame() {
  initAudio();
  playClickSound();

  menu.className = 'hidden';
  game.className = 'active';
  hud.className = 'active';
  controls.className = 'active';
  gameOverScreen.className = '';

  resize();
  generateStars();
  generateMountains();
  generateCity();
  generateTrack();

  // Start background music
  startMusic();

  car.x = 200;
  car.y = getGroundY(200) - 30;
  car.vy = 0;
  car.rotation = 0;
  car.onGround = true;
  car.wheelRotation = 0;
  car.color = carColors[selectedCar].main;
  car.accentColor = carColors[selectedCar].accent;

  // Reset flip state
  isFlipping = false;
  flipRotation = 0;
  lastJumpTime = 0;

  speed = 8;
  score = 0;
  coinsCollected = 0;
  cameraX = 0;
  time = 0;
  particles = [];
  playing = true;
  gameOver = false;
  boosting = false;

  // Reset power-ups
  activeEffects = { shield: 0, magnet: 0, doubleCoins: 0, superJump: 0 };
  updatePowerupDisplay();

  loop();
}

function updatePowerupDisplay() {
  var html = '';
  if (activeEffects.shield > 0) {
    html += '<div class="powerup-indicator powerup-shield">üõ°Ô∏è ' + Math.ceil(activeEffects.shield) + 's</div>';
  }
  if (activeEffects.magnet > 0) {
    html += '<div class="powerup-indicator powerup-magnet">üß≤ ' + Math.ceil(activeEffects.magnet) + 's</div>';
  }
  if (activeEffects.doubleCoins > 0) {
    html += '<div class="powerup-indicator powerup-double">2Ô∏è‚É£ ' + Math.ceil(activeEffects.doubleCoins) + 's</div>';
  }
  if (activeEffects.superJump > 0) {
    html += '<div class="powerup-indicator powerup-superjump">‚¨ÜÔ∏è ' + Math.ceil(activeEffects.superJump) + 's</div>';
  }
  powerupDisplay.innerHTML = html;
}

function endGame() {
  playing = false;
  gameOver = true;
  finalScore.textContent = score;
  gameOverScreen.className = 'active';
  stopMusic();
  playGameOverSound();

  // Reset score submission state
  scoreSubmitted = false;
  submitScoreBtn.textContent = 'SUBMIT SCORE';
  submitScoreBtn.style.opacity = '1';
  highscoreMessage.style.display = 'none';

  // Check if potential high score
  if (checkIfHighScore()) {
    highscoreMessage.textContent = 'NEW HIGH SCORE!';
    highscoreMessage.style.display = 'block';
  }
}

function returnToMenu() {
  playClickSound();
  gameOverScreen.className = '';
  game.className = '';
  hud.className = '';
  controls.className = '';
  menu.className = '';
  gameOver = false;
}

function jump() {
  var now = Date.now();
  var timeSinceLastJump = now - lastJumpTime;

  // Double tap while in air = flip!
  if (!car.onGround && playing && timeSinceLastJump < 400 && !isFlipping) {
    isFlipping = true;
    flipRotation = 0;
    playFlipSound();
    spawnParticle(car.x, car.y, 'powerup');
    // Give a small upward boost for the flip
    car.vy = Math.min(car.vy, -8);
    lastJumpTime = 0; // Reset to prevent triple flip
    return;
  }

  // Normal jump from ground
  if (car.onGround && playing) {
    // Super jump power-up gives higher jump
    car.vy = activeEffects.superJump > 0 ? -25 : -18;
    car.onGround = false;
    spawnParticle(car.x, car.y + 20, 'jump');
    playJumpSound();
    lastJumpTime = now;
  }
}

function loop() {
  if (!playing) return;

  time += 0.016;

  // Boosting
  if (boosting) {
    speed = Math.min(speed + 0.3, maxSpeed);
    if (Math.random() < 0.5) {
      spawnParticle(car.x - 40, car.y + 10, 'boost');
    }
  } else {
    speed = Math.max(speed - 0.05, 8);
  }

  // Physics
  car.vy += 0.8; // gravity
  car.y += car.vy;
  car.x += speed;

  // Update wheel rotation
  car.wheelRotation += speed * 0.1;

  // Ground collision
  var groundY = getGroundY(car.x);
  var groundAngle = getGroundAngle(car.x);

  if (car.y >= groundY - 25) {
    car.y = groundY - 25;
    car.vy = 0;
    car.onGround = true;
    car.rotation = groundAngle;
    isFlipping = false; // Reset flip on landing

    // Speed particles when on ground
    if (speed > 15 && Math.random() < 0.3) {
      spawnParticle(car.x - 30, car.y + 20, 'speed');
    }
  } else {
    car.onGround = false;
    // Handle flip or normal air rotation
    if (isFlipping) {
      flipRotation += flipSpeed;
      car.rotation += flipSpeed;
      // Complete flip after full 360 degrees (2*PI)
      if (flipRotation >= Math.PI * 2) {
        isFlipping = false;
        flipRotation = 0;
        // Bonus points for flip!
        score += 100;
        spawnParticle(car.x, car.y - 30, 'coin');
      }
    } else {
      // Normal slight rotation in air
      car.rotation += 0.03;
    }
  }

  // Camera follow
  cameraX = car.x - canvas.width * 0.25;

  // Collect coins (with magnet effect)
  var magnetRange = activeEffects.magnet > 0 ? 200 : 50;
  for (var i = 0; i < coins.length; i++) {
    var c = coins[i];
    if (!c.collected) {
      var dx = car.x - c.x;
      var dy = car.y - c.y;
      var dist = Math.sqrt(dx * dx + dy * dy);

      // Magnet pulls coins toward car
      if (activeEffects.magnet > 0 && dist < magnetRange && dist > 50) {
        c.x += dx * 0.1;
        c.y += dy * 0.1;
      }

      if (dist < 50) {
        c.collected = true;
        var coinValue = activeEffects.doubleCoins > 0 ? 100 : 50;
        coinsCollected++;
        score += coinValue;
        spawnParticle(c.x, c.y, 'coin');
        playCoinSound();
      }
    }
  }

  // Collect power-ups
  for (var i = 0; i < powerups.length; i++) {
    var p = powerups[i];
    if (!p.collected) {
      var dx = car.x - p.x;
      var dy = car.y - p.y;
      if (Math.sqrt(dx * dx + dy * dy) < 50) {
        p.collected = true;
        activatePowerup(p.type);
        spawnParticle(p.x, p.y, 'powerup');
        playPowerupSound();
      }
    }
  }

  // Update power-up timers
  var dt = 0.016;
  if (activeEffects.shield > 0) activeEffects.shield -= dt;
  if (activeEffects.magnet > 0) activeEffects.magnet -= dt;
  if (activeEffects.doubleCoins > 0) activeEffects.doubleCoins -= dt;
  if (activeEffects.superJump > 0) activeEffects.superJump -= dt;
  updatePowerupDisplay();

  // Update particles
  for (var i = particles.length - 1; i >= 0; i--) {
    var p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.2;
    p.life -= p.decay;
    if (p.life <= 0) {
      particles.splice(i, 1);
    }
  }

  // Score from distance
  score = Math.max(score, Math.floor(car.x / 20));

  // Update HUD
  scoreNum.textContent = score;
  coinNum.textContent = coinsCollected;

  // Respawn if fell off screen (no game over)
  if (car.y > canvas.height + 200) {
    car.y = getGroundY(car.x) - 30;
    car.vy = 0;
    car.onGround = true;
  }

  // DRAW EVERYTHING
  draw();

  requestAnimationFrame(loop);
}

function draw() {
  var w = canvas.width;
  var h = canvas.height;

  // Enhanced sky gradient
  var skyGrad = ctx.createLinearGradient(0, 0, 0, h);
  skyGrad.addColorStop(0, '#050520');
  skyGrad.addColorStop(0.3, '#0a0a3a');
  skyGrad.addColorStop(0.6, '#1a1050');
  skyGrad.addColorStop(0.8, '#2a1a5e');
  skyGrad.addColorStop(1, '#3a2a6e');
  ctx.fillStyle = skyGrad;
  ctx.fillRect(0, 0, w, h);

  // Aurora borealis effect
  ctx.globalAlpha = 0.15;
  var auroraGrad = ctx.createLinearGradient(0, 50, 0, 200);
  auroraGrad.addColorStop(0, '#00ff88');
  auroraGrad.addColorStop(0.5, '#00ffff');
  auroraGrad.addColorStop(1, '#ff00ff');
  ctx.fillStyle = auroraGrad;
  for (var a = 0; a < 3; a++) {
    ctx.beginPath();
    ctx.moveTo(0, 80 + a * 30);
    for (var ax = 0; ax < w; ax += 50) {
      var auroraY = 80 + a * 30 + Math.sin((ax + time * 50 + a * 100) * 0.02) * 30;
      ctx.lineTo(ax, auroraY);
    }
    ctx.lineTo(w, 200);
    ctx.lineTo(0, 200);
    ctx.closePath();
    ctx.fill();
  }
  ctx.globalAlpha = 1;

  // Stars with glow (parallax)
  for (var i = 0; i < stars.length; i++) {
    var s = stars[i];
    var sx = (s.x - cameraX * 0.1) % (w + 100) - 50;
    var twinkle = 0.5 + 0.5 * Math.sin(time * 3 + s.twinkle);

    // Star glow
    ctx.shadowColor = '#ffffff';
    ctx.shadowBlur = s.size * 3;
    ctx.fillStyle = '#ffffff';
    ctx.globalAlpha = twinkle;
    ctx.beginPath();
    ctx.arc(sx, s.y, s.size, 0, Math.PI * 2);
    ctx.fill();

    // Bright stars get extra sparkle
    if (s.size > 1.5) {
      ctx.globalAlpha = twinkle * 0.5;
      ctx.beginPath();
      ctx.moveTo(sx - s.size * 3, s.y);
      ctx.lineTo(sx + s.size * 3, s.y);
      ctx.moveTo(sx, s.y - s.size * 3);
      ctx.lineTo(sx, s.y + s.size * 3);
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 0.5;
      ctx.stroke();
    }
  }
  ctx.globalAlpha = 1;
  ctx.shadowBlur = 0;

  // Enhanced moon with glow and craters
  var moonX = w * 0.8 - cameraX * 0.02;
  var moonPosX = moonX % (w + 200);

  // Moon outer glow
  ctx.fillStyle = 'rgba(255, 255, 200, 0.1)';
  ctx.beginPath();
  ctx.arc(moonPosX, 80, 80, 0, Math.PI * 2);
  ctx.fill();

  // Moon body
  ctx.fillStyle = '#ffffdd';
  ctx.shadowColor = '#ffffcc';
  ctx.shadowBlur = 50;
  ctx.beginPath();
  ctx.arc(moonPosX, 80, 45, 0, Math.PI * 2);
  ctx.fill();

  // Moon surface details (craters)
  ctx.shadowBlur = 0;
  ctx.fillStyle = 'rgba(200, 200, 180, 0.3)';
  ctx.beginPath();
  ctx.arc(moonPosX - 15, 70, 12, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.arc(moonPosX + 10, 90, 8, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.arc(moonPosX + 20, 65, 6, 0, Math.PI * 2);
  ctx.fill();

  // Mountains with gradient (parallax)
  for (var i = 0; i < mountains.length; i++) {
    var m = mountains[i];
    var mx = m.x - cameraX * 0.2;
    if (mx > -m.width && mx < w + m.width) {
      var mtGrad = ctx.createLinearGradient(mx, h - m.height, mx, h);
      mtGrad.addColorStop(0, '#2a2a5e');
      mtGrad.addColorStop(1, '#1a1a3e');
      ctx.fillStyle = mtGrad;
      ctx.beginPath();
      ctx.moveTo(mx, h);
      ctx.lineTo(mx + m.width / 2, h - m.height);
      ctx.lineTo(mx + m.width, h);
      ctx.closePath();
      ctx.fill();

      // Snow caps on tall mountains
      if (m.height > 150) {
        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.beginPath();
        ctx.moveTo(mx + m.width / 2 - 20, h - m.height + 30);
        ctx.lineTo(mx + m.width / 2, h - m.height);
        ctx.lineTo(mx + m.width / 2 + 20, h - m.height + 30);
        ctx.closePath();
        ctx.fill();
      }
    }
  }

  // Enhanced city buildings (parallax)
  for (var i = 0; i < cityBuildings.length; i++) {
    var b = cityBuildings[i];
    var bx = b.x - cameraX * 0.4;
    if (bx > -b.width && bx < w + b.width) {
      // Building gradient
      var bldGrad = ctx.createLinearGradient(bx, h - b.height - 100, bx, h - 100);
      bldGrad.addColorStop(0, '#15152a');
      bldGrad.addColorStop(1, '#0a0a18');
      ctx.fillStyle = bldGrad;
      ctx.fillRect(bx, h - b.height - 100, b.width, b.height);

      // Building edge highlight
      ctx.fillStyle = 'rgba(100, 100, 150, 0.3)';
      ctx.fillRect(bx, h - b.height - 100, 2, b.height);

      // Rooftop antenna/spire on some buildings
      if (b.height > 100 && i % 3 === 0) {
        ctx.strokeStyle = '#ff0066';
        ctx.shadowColor = '#ff0066';
        ctx.shadowBlur = 10;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(bx + b.width / 2, h - b.height - 100);
        ctx.lineTo(bx + b.width / 2, h - b.height - 120);
        ctx.stroke();
        ctx.fillStyle = '#ff0066';
        ctx.beginPath();
        ctx.arc(bx + b.width / 2, h - b.height - 120, 3, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
      }

      // Neon sign on some buildings
      if (i % 5 === 0 && b.height > 80) {
        var neonColors = ['#ff00ff', '#00ffff', '#ff6600', '#00ff00'];
        var neonColor = neonColors[i % neonColors.length];
        ctx.fillStyle = neonColor;
        ctx.shadowColor = neonColor;
        ctx.shadowBlur = 15;
        ctx.fillRect(bx + 5, h - b.height - 80, b.width - 10, 8);
        ctx.shadowBlur = 0;
      }

      // Windows with varied colors
      var windowColors = ['#ffff66', '#66ffff', '#ff66ff', '#ffffff'];
      for (var wy = 0; wy < b.windows; wy++) {
        for (var wx = 0; wx < b.windowCols; wx++) {
          if (Math.sin(wx * 7 + wy * 13 + i * 3) > -0.3) {
            var wColor = windowColors[(wx + wy + i) % windowColors.length];
            ctx.fillStyle = wColor;
            ctx.globalAlpha = 0.4 + Math.sin(time * 2 + wx + wy) * 0.2;
            ctx.fillRect(
              bx + 5 + wx * 15,
              h - b.height - 95 + wy * 20,
              8, 12
            );
          }
        }
      }
      ctx.globalAlpha = 1;
    }
  }

  // Track glow
  ctx.save();
  ctx.translate(-cameraX, 0);

  // Draw track with gradient
  ctx.strokeStyle = '#00ffff';
  ctx.shadowColor = '#00ffff';
  ctx.shadowBlur = 20;
  ctx.lineWidth = 6;
  ctx.beginPath();
  var started = false;
  for (var i = 0; i < track.length - 1; i++) {
    var t = track[i];
    if (t.x > cameraX - 100 && t.x < cameraX + w + 100) {
      if (!started) {
        ctx.moveTo(t.x, t.y);
        started = true;
      } else {
        ctx.lineTo(t.x, t.y);
      }
    }
  }
  ctx.stroke();
  ctx.shadowBlur = 0;

  // Track fill (ground)
  ctx.fillStyle = '#0a0a1a';
  ctx.beginPath();
  started = false;
  for (var i = 0; i < track.length - 1; i++) {
    var t = track[i];
    if (t.x > cameraX - 100 && t.x < cameraX + w + 100) {
      if (!started) {
        ctx.moveTo(t.x, t.y);
        started = true;
      } else {
        ctx.lineTo(t.x, t.y);
      }
    }
  }
  ctx.lineTo(track[track.length - 1].x, h + 100);
  ctx.lineTo(cameraX - 100, h + 100);
  ctx.closePath();
  ctx.fill();

  // Draw coins
  for (var i = 0; i < coins.length; i++) {
    var c = coins[i];
    if (!c.collected && c.x > cameraX - 50 && c.x < cameraX + w + 50) {
      c.rotation += 0.1;

      // Coin glow
      ctx.shadowColor = '#ffcc00';
      ctx.shadowBlur = 15;

      // Coin body
      ctx.fillStyle = '#ffcc00';
      ctx.beginPath();
      ctx.ellipse(c.x, c.y, 18 * Math.abs(Math.cos(c.rotation)), 18, 0, 0, Math.PI * 2);
      ctx.fill();

      // Coin shine
      ctx.fillStyle = '#ffff88';
      ctx.beginPath();
      ctx.ellipse(c.x, c.y, 10 * Math.abs(Math.cos(c.rotation)), 10, 0, 0, Math.PI * 2);
      ctx.fill();

      ctx.shadowBlur = 0;
    }
  }

  // Draw power-ups
  for (var i = 0; i < powerups.length; i++) {
    var p = powerups[i];
    if (!p.collected && p.x > cameraX - 100 && p.x < cameraX + w + 100) {
      p.rotation += 0.05;
      var bobY = Math.sin(time * 4 + p.x) * 8;

      ctx.save();
      ctx.translate(p.x, p.y + bobY);

      // Glow effect
      var glowColor = '#ffffff';
      if (p.type === 'shield') glowColor = '#00aaff';
      else if (p.type === 'magnet') glowColor = '#cc00ff';
      else if (p.type === 'doubleCoins') glowColor = '#ffcc00';
      else if (p.type === 'superJump') glowColor = '#00ff66';

      ctx.shadowColor = glowColor;
      ctx.shadowBlur = 20;

      // Outer ring
      ctx.strokeStyle = glowColor;
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(0, 0, 22, 0, Math.PI * 2);
      ctx.stroke();

      // Inner circle
      ctx.fillStyle = glowColor;
      ctx.globalAlpha = 0.3;
      ctx.beginPath();
      ctx.arc(0, 0, 18, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalAlpha = 1;

      // Icon
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 20px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      if (p.type === 'shield') ctx.fillText('üõ°Ô∏è', 0, 0);
      else if (p.type === 'magnet') ctx.fillText('üß≤', 0, 0);
      else if (p.type === 'doubleCoins') ctx.fillText('2X', 0, 2);
      else if (p.type === 'superJump') ctx.fillText('‚¨ÜÔ∏è', 0, 0);

      ctx.shadowBlur = 0;
      ctx.restore();
    }
  }

  // Draw particles
  for (var i = 0; i < particles.length; i++) {
    var p = particles[i];
    ctx.globalAlpha = p.life;
    ctx.fillStyle = p.color;
    ctx.shadowColor = p.color;
    ctx.shadowBlur = 10;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
  ctx.shadowBlur = 0;

  // Draw car with improved graphics
  ctx.save();
  ctx.translate(car.x, car.y);
  ctx.rotate(car.rotation);

  // Shield bubble effect
  if (activeEffects.shield > 0) {
    ctx.strokeStyle = '#00aaff';
    ctx.shadowColor = '#00aaff';
    ctx.shadowBlur = 25;
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.ellipse(0, 0, 70, 45, 0, 0, Math.PI * 2);
    ctx.stroke();
    ctx.shadowBlur = 0;
  }

  // Undercarriage neon glow
  ctx.fillStyle = car.accentColor;
  ctx.globalAlpha = 0.4;
  ctx.shadowColor = car.accentColor;
  ctx.shadowBlur = 20;
  ctx.beginPath();
  ctx.ellipse(0, 25, 50, 8, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;
  ctx.globalAlpha = 1;

  // Car shadow
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.beginPath();
  ctx.ellipse(0, 30, 55, 12, 0, 0, Math.PI * 2);
  ctx.fill();

  // Main body glow
  ctx.shadowColor = car.color;
  ctx.shadowBlur = 30;

  // Lower body - sleek shape
  ctx.fillStyle = car.color;
  ctx.beginPath();
  ctx.moveTo(-55, 10);
  ctx.quadraticCurveTo(-60, 0, -50, -10);
  ctx.lineTo(-35, -15);
  ctx.lineTo(35, -15);
  ctx.quadraticCurveTo(60, -10, 60, 5);
  ctx.lineTo(60, 12);
  ctx.lineTo(-55, 12);
  ctx.closePath();
  ctx.fill();

  // Upper body / cabin
  ctx.beginPath();
  ctx.moveTo(-20, -15);
  ctx.quadraticCurveTo(-15, -35, 5, -38);
  ctx.quadraticCurveTo(25, -38, 30, -20);
  ctx.lineTo(30, -15);
  ctx.lineTo(-20, -15);
  ctx.closePath();
  ctx.fill();

  ctx.shadowBlur = 0;

  // Accent stripe
  ctx.fillStyle = car.accentColor;
  ctx.globalAlpha = 0.8;
  ctx.fillRect(-50, 2, 105, 8);
  ctx.globalAlpha = 1;

  // Racing stripes on hood
  ctx.fillStyle = car.accentColor;
  ctx.globalAlpha = 0.6;
  ctx.fillRect(-3, -14, 6, 25);
  ctx.globalAlpha = 1;

  // Windshield
  ctx.fillStyle = '#1a3a5c';
  ctx.beginPath();
  ctx.moveTo(-15, -15);
  ctx.quadraticCurveTo(-10, -32, 5, -34);
  ctx.quadraticCurveTo(20, -34, 25, -18);
  ctx.lineTo(25, -15);
  ctx.lineTo(-15, -15);
  ctx.closePath();
  ctx.fill();

  // Windshield reflection
  ctx.fillStyle = 'rgba(255,255,255,0.35)';
  ctx.beginPath();
  ctx.moveTo(-10, -16);
  ctx.lineTo(-5, -28);
  ctx.lineTo(5, -28);
  ctx.lineTo(0, -16);
  ctx.closePath();
  ctx.fill();

  // Side window
  ctx.fillStyle = '#1a3a5c';
  ctx.beginPath();
  ctx.moveTo(-18, -14);
  ctx.lineTo(-25, -14);
  ctx.lineTo(-22, -8);
  ctx.lineTo(-18, -8);
  ctx.closePath();
  ctx.fill();

  // Front spoiler
  ctx.fillStyle = car.accentColor;
  ctx.fillRect(50, 6, 12, 6);

  // Rear spoiler wing
  ctx.fillStyle = car.accentColor;
  ctx.beginPath();
  ctx.moveTo(-52, -12);
  ctx.lineTo(-62, -22);
  ctx.lineTo(-52, -22);
  ctx.lineTo(-48, -15);
  ctx.closePath();
  ctx.fill();
  ctx.fillRect(-55, -22, 3, 10);

  // Air intake
  ctx.fillStyle = '#111';
  ctx.fillRect(10, -14, 15, 4);
  ctx.fillStyle = car.accentColor;
  ctx.globalAlpha = 0.5;
  ctx.fillRect(11, -13, 13, 2);
  ctx.globalAlpha = 1;

  // Headlights with lens flare
  ctx.fillStyle = '#ffffcc';
  ctx.shadowColor = '#ffffaa';
  ctx.shadowBlur = 30;
  ctx.beginPath();
  ctx.ellipse(56, -5, 6, 4, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.ellipse(56, 5, 6, 4, 0, 0, Math.PI * 2);
  ctx.fill();

  // Tail lights
  ctx.fillStyle = '#ff0033';
  ctx.shadowColor = '#ff0000';
  ctx.shadowBlur = 20;
  ctx.beginPath();
  ctx.ellipse(-54, -5, 5, 3, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.ellipse(-54, 5, 5, 3, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;

  // Exhaust
  ctx.fillStyle = '#444';
  ctx.beginPath();
  ctx.ellipse(-58, 8, 4, 3, 0, 0, Math.PI * 2);
  ctx.fill();

  // Front wheel with improved detail
  ctx.save();
  ctx.translate(35, 18);
  ctx.rotate(car.wheelRotation);
  drawWheel(ctx, 0, 0, 16, car.color, car.accentColor);
  ctx.restore();

  // Rear wheel
  ctx.save();
  ctx.translate(-35, 18);
  ctx.rotate(car.wheelRotation);
  drawWheel(ctx, 0, 0, 16, car.color, car.accentColor);
  ctx.restore();

  // Boost flame with multiple layers
  if (boosting) {
    // Outer flame
    ctx.fillStyle = '#ff3300';
    ctx.shadowColor = '#ff6600';
    ctx.shadowBlur = 30;
    var flameSize = 20 + Math.random() * 25;
    ctx.beginPath();
    ctx.moveTo(-55, -4);
    ctx.lineTo(-55 - flameSize, 4);
    ctx.lineTo(-55, 12);
    ctx.closePath();
    ctx.fill();

    // Middle flame
    ctx.fillStyle = '#ff6600';
    flameSize = 15 + Math.random() * 15;
    ctx.beginPath();
    ctx.moveTo(-55, 0);
    ctx.lineTo(-55 - flameSize, 4);
    ctx.lineTo(-55, 8);
    ctx.closePath();
    ctx.fill();

    // Inner flame
    ctx.fillStyle = '#ffff00';
    flameSize = 8 + Math.random() * 10;
    ctx.beginPath();
    ctx.moveTo(-55, 2);
    ctx.lineTo(-55 - flameSize, 4);
    ctx.lineTo(-55, 6);
    ctx.closePath();
    ctx.fill();
    ctx.shadowBlur = 0;
  }

  ctx.restore();
  ctx.restore();
}

// Button event helper
function addButtonEvent(btn, callback, isHold) {
  var active = false;

  btn.addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    active = true;
    if (isHold) {
      callback(true);
    } else {
      callback();
    }
  }, { passive: false });

  btn.addEventListener('touchend', function(e) {
    e.preventDefault();
    active = false;
    if (isHold) {
      callback(false);
    }
  }, { passive: false });

  btn.addEventListener('mousedown', function(e) {
    active = true;
    if (isHold) {
      callback(true);
    } else {
      callback();
    }
  });

  btn.addEventListener('mouseup', function(e) {
    active = false;
    if (isHold) {
      callback(false);
    }
  });

  btn.addEventListener('mouseleave', function(e) {
    if (active && isHold) {
      active = false;
      callback(false);
    }
  });
}

// Menu buttons
addButtonEvent(playBtn, startGame, false);
addButtonEvent(garageBtn, showGarage, false);
addButtonEvent(leaderboardBtn, function() {
  initAudio();
  showLeaderboard();
}, false);

// Garage buttons
addButtonEvent(prevCarBtn, prevCar, false);
addButtonEvent(nextCarBtn, nextCar, false);
addButtonEvent(selectCarBtn, selectCar, false);
addButtonEvent(closeGarageBtn, hideGarage, false);

// Leaderboard buttons
addButtonEvent(closeLeaderboardBtn, hideLeaderboard, false);
addButtonEvent(submitScoreBtn, submitScore, false);

// Game controls
addButtonEvent(jumpBtn, jump, false);
addButtonEvent(endRunBtn, function() {
  if (playing) endGame();
}, false);
addButtonEvent(boostBtn, function(down) {
  boosting = down;
  if (down) {
    playBoostStartSound();
  } else {
    stopBoostSound();
  }
}, true);

// Game over buttons
addButtonEvent(retryBtn, startGame, false);
addButtonEvent(menuBtn, returnToMenu, false);

// Keyboard controls
document.addEventListener('keydown', function(e) {
  if (e.code === 'Space' || e.code === 'ArrowUp') {
    e.preventDefault();
    jump();
  }
  if (e.code === 'ShiftLeft' || e.code === 'ShiftRight' || e.code === 'ArrowRight') {
    if (!boosting) {
      boosting = true;
      playBoostStartSound();
    }
  }
});

document.addEventListener('keyup', function(e) {
  if (e.code === 'ShiftLeft' || e.code === 'ShiftRight' || e.code === 'ArrowRight') {
    boosting = false;
    stopBoostSound();
  }
});

// Resize handler
window.addEventListener('resize', resize);

// Prevent scrolling
document.body.addEventListener('touchmove', function(e) {
  if (playing) e.preventDefault();
}, { passive: false });

// Fetch leaderboard on page load
fetchLeaderboard();

// Register Service Worker for PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js')
      .then(function(registration) {
        console.log('ServiceWorker registered:', registration.scope);
      })
      .catch(function(error) {
        console.log('ServiceWorker registration failed:', error);
      });
  });
}
</script>

</body>
</html>
