<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Lenny's Rider</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #0a0a1a;
      font-family: 'Arial Black', Arial, sans-serif;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    #menu {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, #0a0a2e 0%, #1a0a3e 50%, #2a1a4e 100%);
    }

    #menu.hidden { display: none; }

    .title {
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 0 0 30px #00ffff, 0 0 60px #00ffff;
      color: #fff;
      letter-spacing: 4px;
    }

    .subtitle {
      color: #ff00ff;
      font-size: 1.2em;
      margin-bottom: 40px;
      text-shadow: 0 0 20px #ff00ff;
    }

    .car-preview {
      font-size: 80px;
      margin-bottom: 30px;
      animation: carBounce 1s ease-in-out infinite;
    }

    @keyframes carBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .btn {
      background: linear-gradient(180deg, #00ff88 0%, #00cc66 100%);
      color: #003322;
      border: none;
      padding: 20px 60px;
      font-size: 24px;
      font-weight: bold;
      border-radius: 50px;
      margin: 10px;
      cursor: pointer;
      -webkit-appearance: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      box-shadow: 0 0 20px rgba(0,255,136,0.5), inset 0 2px 0 rgba(255,255,255,0.3);
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .btn:active {
      transform: scale(0.95);
      box-shadow: 0 0 10px rgba(0,255,136,0.5);
    }

    .btn.garage {
      background: linear-gradient(180deg, #ff00ff 0%, #cc00cc 100%);
      color: #330033;
      box-shadow: 0 0 20px rgba(255,0,255,0.5), inset 0 2px 0 rgba(255,255,255,0.3);
    }

    #game {
      display: none;
      width: 100%;
      height: 100%;
    }

    #game.active { display: block; }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    #controls {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
      display: none;
      justify-content: space-between;
      padding: 0 20px;
      pointer-events: none;
    }

    #controls.active { display: flex; }

    #boost, #jump {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 3px solid;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      -webkit-appearance: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      z-index: 1000;
      pointer-events: auto;
      text-transform: uppercase;
    }

    #boost {
      background: linear-gradient(180deg, #ff6600 0%, #cc4400 100%);
      border-color: #ff8833;
      color: #fff;
      box-shadow: 0 0 20px rgba(255,102,0,0.6);
    }

    #jump {
      background: linear-gradient(180deg, #00ff88 0%, #00cc66 100%);
      border-color: #00ffaa;
      color: #003322;
      box-shadow: 0 0 20px rgba(0,255,136,0.6);
    }

    #hud {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 15px 20px;
      display: none;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(180deg, rgba(0,0,0,0.5) 0%, transparent 100%);
    }

    #hud.active { display: flex; }

    .hud-item {
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      text-shadow: 0 0 10px currentColor;
    }

    .hud-score { color: #00ffff; }
    .hud-coins { color: #ffcc00; }
    .hud-speed { color: #ff00ff; }

    #gameOver {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    #gameOver.active { display: flex; }

    .game-over-title {
      color: #ff0066;
      font-size: 3em;
      text-shadow: 0 0 30px #ff0066;
      margin-bottom: 20px;
    }

    .final-score {
      color: #00ffff;
      font-size: 2em;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>

<div id="menu">
  <div class="car-preview">üèéÔ∏è</div>
  <div class="title">LENNY'S RIDER</div>
  <div class="subtitle">Ultimate Neon Racing</div>
  <button class="btn" id="playBtn">PLAY</button>
  <button class="btn garage" id="garageBtn">GARAGE</button>
</div>

<div id="game">
  <canvas id="canvas"></canvas>
</div>

<div id="hud">
  <div class="hud-item hud-score">SCORE: <span id="scoreNum">0</span></div>
  <div class="hud-item hud-coins">COINS: <span id="coinNum">0</span></div>
  <div class="hud-item hud-speed">SPEED: <span id="speedNum">0</span></div>
</div>

<div id="controls">
  <button id="boost">BOOST</button>
  <button id="jump">JUMP</button>
</div>

<div id="gameOver">
  <div class="game-over-title">GAME OVER</div>
  <div class="final-score">Score: <span id="finalScore">0</span></div>
  <button class="btn" id="retryBtn">RETRY</button>
  <button class="btn garage" id="menuBtn">MENU</button>
</div>

<script>
// ===========================================
// LENNY'S RIDER - Ultimate Neon Racing Game
// ===========================================

var menu = document.getElementById('menu');
var game = document.getElementById('game');
var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
var hud = document.getElementById('hud');
var controls = document.getElementById('controls');
var gameOverScreen = document.getElementById('gameOver');

var playBtn = document.getElementById('playBtn');
var garageBtn = document.getElementById('garageBtn');
var boostBtn = document.getElementById('boost');
var jumpBtn = document.getElementById('jump');
var retryBtn = document.getElementById('retryBtn');
var menuBtn = document.getElementById('menuBtn');

var scoreNum = document.getElementById('scoreNum');
var coinNum = document.getElementById('coinNum');
var speedNum = document.getElementById('speedNum');
var finalScore = document.getElementById('finalScore');

// Game state
var playing = false;
var gameOver = false;
var score = 0;
var coinsCollected = 0;
var speed = 8;
var maxSpeed = 25;
var cameraX = 0;
var time = 0;

// Car properties
var car = {
  x: 200,
  y: 300,
  vy: 0,
  rotation: 0,
  onGround: true,
  wheelRotation: 0,
  color: '#00ffff',
  accentColor: '#ff00ff'
};

// Track and objects
var track = [];
var coins = [];
var particles = [];
var stars = [];
var cityBuildings = [];
var mountains = [];

// Controls
var boosting = false;
var jumpPressed = false;

// Selected car (for garage)
var carColors = [
  { main: '#00ffff', accent: '#ff00ff', name: 'Neon Cyan' },
  { main: '#ff0066', accent: '#ffff00', name: 'Hot Pink' },
  { main: '#00ff00', accent: '#00ffff', name: 'Electric Green' },
  { main: '#ff6600', accent: '#ffff00', name: 'Flame Orange' },
  { main: '#9900ff', accent: '#00ffff', name: 'Purple Rain' },
  { main: '#ffff00', accent: '#ff0066', name: 'Golden Flash' }
];
var selectedCar = 0;

// Generate stars for background
function generateStars() {
  stars = [];
  for (var i = 0; i < 200; i++) {
    stars.push({
      x: Math.random() * 5000,
      y: Math.random() * 300,
      size: Math.random() * 2 + 0.5,
      twinkle: Math.random() * Math.PI * 2
    });
  }
}

// Generate city buildings
function generateCity() {
  cityBuildings = [];
  var x = -200;
  while (x < 50000) {
    var height = 50 + Math.random() * 150;
    var width = 30 + Math.random() * 50;
    cityBuildings.push({
      x: x,
      width: width,
      height: height,
      windows: Math.floor(height / 20),
      windowCols: Math.floor(width / 15)
    });
    x += width + 20 + Math.random() * 60;
  }
}

// Generate mountains
function generateMountains() {
  mountains = [];
  var x = -500;
  while (x < 50000) {
    var height = 100 + Math.random() * 200;
    mountains.push({
      x: x,
      height: height,
      width: 200 + Math.random() * 300
    });
    x += 150 + Math.random() * 200;
  }
}

// Generate track
function generateTrack() {
  track = [];
  coins = [];
  var x = -200;
  var y = 450;

  for (var i = 0; i < 2000; i++) {
    // Create hills and valleys
    if (i > 20 && Math.random() < 0.08) {
      var change = (Math.random() - 0.5) * 60;
      y = Math.max(250, Math.min(550, y + change));
    }

    track.push({ x: x, y: y });

    // Add coins
    if (i > 10 && Math.random() < 0.12) {
      coins.push({
        x: x,
        y: y - 80,
        collected: false,
        rotation: Math.random() * Math.PI * 2
      });
    }

    x += 80;
  }
}

function getGroundY(px) {
  for (var i = 0; i < track.length - 1; i++) {
    if (px >= track[i].x && px < track[i + 1].x) {
      var t = (px - track[i].x) / (track[i + 1].x - track[i].x);
      return track[i].y * (1 - t) + track[i + 1].y * t;
    }
  }
  return 600;
}

function getGroundAngle(px) {
  for (var i = 0; i < track.length - 1; i++) {
    if (px >= track[i].x && px < track[i + 1].x) {
      var dx = track[i + 1].x - track[i].x;
      var dy = track[i + 1].y - track[i].y;
      return Math.atan2(dy, dx);
    }
  }
  return 0;
}

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

function spawnParticle(x, y, type) {
  var color = type === 'boost' ? '#ff6600' : type === 'coin' ? '#ffcc00' : '#00ffff';
  for (var i = 0; i < (type === 'coin' ? 10 : 3); i++) {
    particles.push({
      x: x,
      y: y,
      vx: (Math.random() - 0.5) * (type === 'coin' ? 8 : 4),
      vy: -Math.random() * 5 - 2,
      life: 1,
      decay: 0.02 + Math.random() * 0.02,
      size: type === 'coin' ? 4 + Math.random() * 4 : 2 + Math.random() * 3,
      color: color
    });
  }
}

function startGame() {
  menu.className = 'hidden';
  game.className = 'active';
  hud.className = 'active';
  controls.className = 'active';
  gameOverScreen.className = '';

  resize();
  generateStars();
  generateMountains();
  generateCity();
  generateTrack();

  car.x = 200;
  car.y = getGroundY(200) - 30;
  car.vy = 0;
  car.rotation = 0;
  car.onGround = true;
  car.wheelRotation = 0;
  car.color = carColors[selectedCar].main;
  car.accentColor = carColors[selectedCar].accent;

  speed = 8;
  score = 0;
  coinsCollected = 0;
  cameraX = 0;
  time = 0;
  particles = [];
  playing = true;
  gameOver = false;
  boosting = false;

  loop();
}

function endGame() {
  playing = false;
  gameOver = true;
  finalScore.textContent = score;
  gameOverScreen.className = 'active';
}

function returnToMenu() {
  gameOverScreen.className = '';
  game.className = '';
  hud.className = '';
  controls.className = '';
  menu.className = '';
  gameOver = false;
}

function jump() {
  if (car.onGround && playing) {
    car.vy = -18;
    car.onGround = false;
    spawnParticle(car.x, car.y + 20, 'jump');
  }
}

function loop() {
  if (!playing) return;

  time += 0.016;

  // Boosting
  if (boosting) {
    speed = Math.min(speed + 0.3, maxSpeed);
    if (Math.random() < 0.5) {
      spawnParticle(car.x - 40, car.y + 10, 'boost');
    }
  } else {
    speed = Math.max(speed - 0.05, 8);
  }

  // Physics
  car.vy += 0.8; // gravity
  car.y += car.vy;
  car.x += speed;

  // Update wheel rotation
  car.wheelRotation += speed * 0.1;

  // Ground collision
  var groundY = getGroundY(car.x);
  var groundAngle = getGroundAngle(car.x);

  if (car.y >= groundY - 25) {
    car.y = groundY - 25;
    car.vy = 0;
    car.onGround = true;
    car.rotation = groundAngle;

    // Speed particles when on ground
    if (speed > 15 && Math.random() < 0.3) {
      spawnParticle(car.x - 30, car.y + 20, 'speed');
    }
  } else {
    car.onGround = false;
    // Rotate in air
    car.rotation += 0.03;
  }

  // Camera follow
  cameraX = car.x - canvas.width * 0.25;

  // Collect coins
  for (var i = 0; i < coins.length; i++) {
    var c = coins[i];
    if (!c.collected) {
      var dx = car.x - c.x;
      var dy = car.y - c.y;
      if (Math.sqrt(dx * dx + dy * dy) < 50) {
        c.collected = true;
        coinsCollected++;
        score += 50;
        spawnParticle(c.x, c.y, 'coin');
      }
    }
  }

  // Update particles
  for (var i = particles.length - 1; i >= 0; i--) {
    var p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.2;
    p.life -= p.decay;
    if (p.life <= 0) {
      particles.splice(i, 1);
    }
  }

  // Score from distance
  score = Math.max(score, Math.floor(car.x / 20));

  // Update HUD
  scoreNum.textContent = score;
  coinNum.textContent = coinsCollected;
  speedNum.textContent = Math.floor(speed * 10);

  // Check game over (fell off screen)
  if (car.y > canvas.height + 200) {
    endGame();
    return;
  }

  // DRAW EVERYTHING
  draw();

  requestAnimationFrame(loop);
}

function draw() {
  var w = canvas.width;
  var h = canvas.height;

  // Sky gradient
  var skyGrad = ctx.createLinearGradient(0, 0, 0, h);
  skyGrad.addColorStop(0, '#0a0a2e');
  skyGrad.addColorStop(0.5, '#1a1a4e');
  skyGrad.addColorStop(1, '#2a1a5e');
  ctx.fillStyle = skyGrad;
  ctx.fillRect(0, 0, w, h);

  // Stars (parallax)
  ctx.fillStyle = '#ffffff';
  for (var i = 0; i < stars.length; i++) {
    var s = stars[i];
    var sx = (s.x - cameraX * 0.1) % (w + 100) - 50;
    var twinkle = 0.5 + 0.5 * Math.sin(time * 3 + s.twinkle);
    ctx.globalAlpha = twinkle;
    ctx.beginPath();
    ctx.arc(sx, s.y, s.size, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;

  // Moon
  var moonX = w * 0.8 - cameraX * 0.02;
  ctx.fillStyle = '#ffffcc';
  ctx.shadowColor = '#ffffcc';
  ctx.shadowBlur = 30;
  ctx.beginPath();
  ctx.arc(moonX % (w + 200), 80, 40, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;

  // Mountains (parallax)
  ctx.fillStyle = '#1a1a3e';
  for (var i = 0; i < mountains.length; i++) {
    var m = mountains[i];
    var mx = m.x - cameraX * 0.2;
    if (mx > -m.width && mx < w + m.width) {
      ctx.beginPath();
      ctx.moveTo(mx, h);
      ctx.lineTo(mx + m.width / 2, h - m.height);
      ctx.lineTo(mx + m.width, h);
      ctx.closePath();
      ctx.fill();
    }
  }

  // City buildings (parallax)
  for (var i = 0; i < cityBuildings.length; i++) {
    var b = cityBuildings[i];
    var bx = b.x - cameraX * 0.4;
    if (bx > -b.width && bx < w + b.width) {
      // Building body
      ctx.fillStyle = '#0a0a1a';
      ctx.fillRect(bx, h - b.height - 100, b.width, b.height);

      // Windows
      ctx.fillStyle = '#ffff66';
      for (var wy = 0; wy < b.windows; wy++) {
        for (var wx = 0; wx < b.windowCols; wx++) {
          if (Math.random() > 0.3) {
            ctx.globalAlpha = 0.3 + Math.random() * 0.5;
            ctx.fillRect(
              bx + 5 + wx * 15,
              h - b.height - 95 + wy * 20,
              8, 12
            );
          }
        }
      }
      ctx.globalAlpha = 1;
    }
  }

  // Track glow
  ctx.save();
  ctx.translate(-cameraX, 0);

  // Draw track with gradient
  ctx.strokeStyle = '#00ffff';
  ctx.shadowColor = '#00ffff';
  ctx.shadowBlur = 20;
  ctx.lineWidth = 6;
  ctx.beginPath();
  var started = false;
  for (var i = 0; i < track.length - 1; i++) {
    var t = track[i];
    if (t.x > cameraX - 100 && t.x < cameraX + w + 100) {
      if (!started) {
        ctx.moveTo(t.x, t.y);
        started = true;
      } else {
        ctx.lineTo(t.x, t.y);
      }
    }
  }
  ctx.stroke();
  ctx.shadowBlur = 0;

  // Track fill (ground)
  ctx.fillStyle = '#0a0a1a';
  ctx.beginPath();
  started = false;
  for (var i = 0; i < track.length - 1; i++) {
    var t = track[i];
    if (t.x > cameraX - 100 && t.x < cameraX + w + 100) {
      if (!started) {
        ctx.moveTo(t.x, t.y);
        started = true;
      } else {
        ctx.lineTo(t.x, t.y);
      }
    }
  }
  ctx.lineTo(track[track.length - 1].x, h + 100);
  ctx.lineTo(cameraX - 100, h + 100);
  ctx.closePath();
  ctx.fill();

  // Draw coins
  for (var i = 0; i < coins.length; i++) {
    var c = coins[i];
    if (!c.collected && c.x > cameraX - 50 && c.x < cameraX + w + 50) {
      c.rotation += 0.1;

      // Coin glow
      ctx.shadowColor = '#ffcc00';
      ctx.shadowBlur = 15;

      // Coin body
      ctx.fillStyle = '#ffcc00';
      ctx.beginPath();
      ctx.ellipse(c.x, c.y, 18 * Math.abs(Math.cos(c.rotation)), 18, 0, 0, Math.PI * 2);
      ctx.fill();

      // Coin shine
      ctx.fillStyle = '#ffff88';
      ctx.beginPath();
      ctx.ellipse(c.x, c.y, 10 * Math.abs(Math.cos(c.rotation)), 10, 0, 0, Math.PI * 2);
      ctx.fill();

      ctx.shadowBlur = 0;
    }
  }

  // Draw particles
  for (var i = 0; i < particles.length; i++) {
    var p = particles[i];
    ctx.globalAlpha = p.life;
    ctx.fillStyle = p.color;
    ctx.shadowColor = p.color;
    ctx.shadowBlur = 10;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
  ctx.shadowBlur = 0;

  // Draw car
  ctx.save();
  ctx.translate(car.x, car.y);
  ctx.rotate(car.rotation);

  // Car shadow
  ctx.fillStyle = 'rgba(0,0,0,0.3)';
  ctx.beginPath();
  ctx.ellipse(0, 25, 35, 8, 0, 0, Math.PI * 2);
  ctx.fill();

  // Car body glow
  ctx.shadowColor = car.color;
  ctx.shadowBlur = 20;

  // Car body (main)
  ctx.fillStyle = car.color;
  ctx.beginPath();
  ctx.moveTo(-40, 5);
  ctx.lineTo(-35, -10);
  ctx.lineTo(-15, -15);
  ctx.lineTo(5, -20);
  ctx.lineTo(25, -15);
  ctx.lineTo(40, -5);
  ctx.lineTo(40, 10);
  ctx.lineTo(-40, 10);
  ctx.closePath();
  ctx.fill();

  // Car roof
  ctx.fillStyle = car.accentColor;
  ctx.beginPath();
  ctx.moveTo(-15, -15);
  ctx.lineTo(-5, -25);
  ctx.lineTo(15, -25);
  ctx.lineTo(25, -15);
  ctx.closePath();
  ctx.fill();

  // Windows
  ctx.fillStyle = '#003366';
  ctx.beginPath();
  ctx.moveTo(-12, -14);
  ctx.lineTo(-3, -22);
  ctx.lineTo(12, -22);
  ctx.lineTo(22, -14);
  ctx.closePath();
  ctx.fill();

  // Window shine
  ctx.fillStyle = 'rgba(255,255,255,0.3)';
  ctx.beginPath();
  ctx.moveTo(-10, -14);
  ctx.lineTo(-3, -20);
  ctx.lineTo(2, -20);
  ctx.lineTo(-5, -14);
  ctx.closePath();
  ctx.fill();

  ctx.shadowBlur = 0;

  // Headlights
  ctx.fillStyle = '#ffff88';
  ctx.shadowColor = '#ffff88';
  ctx.shadowBlur = 15;
  ctx.beginPath();
  ctx.ellipse(38, 0, 5, 4, 0, 0, Math.PI * 2);
  ctx.fill();

  // Tail lights
  ctx.fillStyle = '#ff0000';
  ctx.shadowColor = '#ff0000';
  ctx.beginPath();
  ctx.ellipse(-38, 0, 4, 3, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;

  // Wheels
  ctx.fillStyle = '#111';
  ctx.strokeStyle = car.accentColor;
  ctx.lineWidth = 3;

  // Front wheel
  ctx.save();
  ctx.translate(22, 15);
  ctx.rotate(car.wheelRotation);
  ctx.beginPath();
  ctx.arc(0, 0, 12, 0, Math.PI * 2);
  ctx.fill();
  ctx.stroke();
  // Wheel spokes
  ctx.strokeStyle = '#444';
  ctx.lineWidth = 2;
  for (var i = 0; i < 5; i++) {
    ctx.beginPath();
    ctx.moveTo(0, 0);
    var angle = (i / 5) * Math.PI * 2;
    ctx.lineTo(Math.cos(angle) * 8, Math.sin(angle) * 8);
    ctx.stroke();
  }
  ctx.restore();

  // Rear wheel
  ctx.save();
  ctx.translate(-25, 15);
  ctx.rotate(car.wheelRotation);
  ctx.beginPath();
  ctx.arc(0, 0, 12, 0, Math.PI * 2);
  ctx.fill();
  ctx.strokeStyle = car.accentColor;
  ctx.lineWidth = 3;
  ctx.stroke();
  // Wheel spokes
  ctx.strokeStyle = '#444';
  ctx.lineWidth = 2;
  for (var i = 0; i < 5; i++) {
    ctx.beginPath();
    ctx.moveTo(0, 0);
    var angle = (i / 5) * Math.PI * 2;
    ctx.lineTo(Math.cos(angle) * 8, Math.sin(angle) * 8);
    ctx.stroke();
  }
  ctx.restore();

  // Boost flame
  if (boosting) {
    ctx.fillStyle = '#ff6600';
    ctx.shadowColor = '#ff6600';
    ctx.shadowBlur = 20;
    var flameSize = 15 + Math.random() * 15;
    ctx.beginPath();
    ctx.moveTo(-42, -2);
    ctx.lineTo(-42 - flameSize, 3);
    ctx.lineTo(-42, 8);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = '#ffff00';
    flameSize = 8 + Math.random() * 8;
    ctx.beginPath();
    ctx.moveTo(-42, 0);
    ctx.lineTo(-42 - flameSize, 3);
    ctx.lineTo(-42, 6);
    ctx.closePath();
    ctx.fill();
    ctx.shadowBlur = 0;
  }

  ctx.restore();
  ctx.restore();
}

// Button event helper
function addButtonEvent(btn, callback, isHold) {
  var active = false;

  btn.addEventListener('touchstart', function(e) {
    e.preventDefault();
    e.stopPropagation();
    active = true;
    if (isHold) {
      callback(true);
    } else {
      callback();
    }
  }, { passive: false });

  btn.addEventListener('touchend', function(e) {
    e.preventDefault();
    active = false;
    if (isHold) {
      callback(false);
    }
  }, { passive: false });

  btn.addEventListener('mousedown', function(e) {
    active = true;
    if (isHold) {
      callback(true);
    } else {
      callback();
    }
  });

  btn.addEventListener('mouseup', function(e) {
    active = false;
    if (isHold) {
      callback(false);
    }
  });

  btn.addEventListener('mouseleave', function(e) {
    if (active && isHold) {
      active = false;
      callback(false);
    }
  });
}

// Menu buttons
addButtonEvent(playBtn, startGame, false);
addButtonEvent(garageBtn, function() {
  selectedCar = (selectedCar + 1) % carColors.length;
  alert('Selected: ' + carColors[selectedCar].name + '! All cars are FREE!');
}, false);

// Game controls
addButtonEvent(jumpBtn, jump, false);
addButtonEvent(boostBtn, function(down) {
  boosting = down;
}, true);

// Game over buttons
addButtonEvent(retryBtn, startGame, false);
addButtonEvent(menuBtn, returnToMenu, false);

// Keyboard controls
document.addEventListener('keydown', function(e) {
  if (e.code === 'Space' || e.code === 'ArrowUp') {
    e.preventDefault();
    jump();
  }
  if (e.code === 'ShiftLeft' || e.code === 'ShiftRight' || e.code === 'ArrowRight') {
    boosting = true;
  }
});

document.addEventListener('keyup', function(e) {
  if (e.code === 'ShiftLeft' || e.code === 'ShiftRight' || e.code === 'ArrowRight') {
    boosting = false;
  }
});

// Resize handler
window.addEventListener('resize', resize);

// Prevent scrolling
document.body.addEventListener('touchmove', function(e) {
  if (playing) e.preventDefault();
}, { passive: false });
</script>

</body>
</html>
